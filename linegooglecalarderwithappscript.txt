
// ==========================================
// Open Source Appointment Bot (Lite Version)
// æ•™å­¸ç‰ˆ - é™„å¸¶è¨­å®šæª¢æŸ¥åŠŸèƒ½
// ==========================================

// ğŸŸ¢ å­¸ç”Ÿä½œæ¥­å€ (å¡«å¯«å®Œç•¢å¾Œè«‹æŒ‰ã€Œå„²å­˜ã€)

// 1. è«‹å¡«å…¥ LINE Channel Access Token
var CHANNEL_ACCESS_TOKEN = 'YOUR_CHANNEL_ACCESS_TOKEN_HERE'; 

// 2. è«‹å¡«å…¥ Google Sheet ID (è©¦ç®—è¡¨ç¶²å€ /d/ åˆ° /edit ä¸­é–“çš„äº‚ç¢¼)
var SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; 

// 3. åº—é•·çš„ LINE User ID (ç¬¬ä¸€æ¬¡éƒ¨ç½²å¾Œï¼Œå°æ©Ÿå™¨äººè¼¸å…¥ã€ŒæŸ¥è©¢IDã€å¯å–å¾—)
var MANAGER_USER_ID = 'YOUR_MANAGER_USER_ID_HERE'; 

// 4. è«‹å¡«å…¥ Web App URL (é»æ“Šã€Œéƒ¨ç½²ã€->ã€Œæ–°å¢éƒ¨ç½²ã€å¾Œå–å¾—çš„ç¶²å€)
var WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE'; 

// ==========================================
// é€²éšè¨­å®š (é€šå¸¸ä¸ç”¨æ”¹)
var CALENDAR_ID = 'primary'; 
var SHEET_TAB_NAME = 'Member_DB';
// ==========================================

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ğŸ¤– æ©Ÿå™¨äººè¨­å®š')
      .addItem('0. æª¢æŸ¥è¨­å®šç‹€æ…‹ (æ•™å­¸ç”¨)', 'checkSettings')
      .addSeparator()
      .addItem('1. åˆå§‹åŒ–è³‡æ–™è¡¨', 'initSheet')
      .addItem('2. å•Ÿå‹•æ—¥æ›†ç›£æ§ (Webhook)', 'setupCalendarWebhook')
      .addItem('3. æ¸¬è©¦ç™¼é€æ—¥å ±', 'runDailyReport')
      .addItem('4. æ¸¬è©¦æ˜æ—¥é ç´„æé†’', 'runPreArrivalReminder')
      .addToUi();
}

// ğŸ“ æ•™å­¸è¼”åŠ©åŠŸèƒ½ï¼šæª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å¿˜è¨˜å¡«è³‡æ–™
function checkSettings() {
  var ui = SpreadsheetApp.getUi();
  var errors = [];
  
  if (!CHANNEL_ACCESS_TOKEN || CHANNEL_ACCESS_TOKEN.indexOf('YOUR_') > -1) {
    errors.push("âŒ å°šæœªå¡«å¯« LINE Channel Access Token");
  }
  if (!SHEET_ID || SHEET_ID.indexOf('YOUR_') > -1) {
    errors.push("âŒ å°šæœªå¡«å¯« Google Sheet ID");
  }
  if (!WEB_APP_URL || WEB_APP_URL.indexOf('YOUR_') > -1) {
    errors.push("âš ï¸ å°šæœªå¡«å¯« Web App URL (è‹¥å°šæœªéƒ¨ç½²ï¼Œè«‹å¿½è¦–æ­¤é …)");
  }
  
  if (errors.length > 0) {
    ui.alert("è¨­å®šæª¢æŸ¥æœªé€šéï¼š\n\n" + errors.join("\n") + "\n\nè«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸Šæ–¹çš„è®Šæ•¸å¾Œï¼ŒæŒ‰ã€Œå„²å­˜ã€å†è©¦ä¸€æ¬¡ã€‚");
  } else {
    ui.alert("âœ… è¨­å®šçœ‹èµ·ä¾†éƒ½å¡«å¥½äº†ï¼\n\næ¥ä¸‹ä¾†è«‹ä¾åºåŸ·è¡Œï¼š\n1. åˆå§‹åŒ–è³‡æ–™è¡¨\n2. å•Ÿå‹•æ—¥æ›†ç›£æ§\n\n(è¨˜å¾—è¦æˆæ¬Šå–”ï¼)");
  }
}

function initSheet() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sheet = ss.getSheetByName(SHEET_TAB_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_TAB_NAME);
    sheet.appendRow(['UserID', 'Phone', 'Name', 'CreatedAt']);
    sheet.setFrozenRows(1);
    SpreadsheetApp.getUi().alert('âœ… è³‡æ–™è¡¨åˆå§‹åŒ–å®Œæˆï¼');
  } else {
    SpreadsheetApp.getUi().alert('âš ï¸ è³‡æ–™è¡¨å·²å­˜åœ¨ï¼Œä¸éœ€é‡è¤‡åŸ·è¡Œã€‚');
  }
}

// ==========================================
// 2. æ ¸å¿ƒè™•ç† (Webhook Handler)
// ==========================================

function doPost(e) {
  var lock = LockService.getScriptLock();
  if (!lock.tryLock(5000)) return ContentService.createTextOutput("Busy");

  try {
    // A. è™•ç† Google Calendar é€šçŸ¥
    if (e.parameter && e.parameter.source === 'calendar') {
      handleCalendarWebhook();
      return ContentService.createTextOutput("200 OK");
    }

    // B. è™•ç† LINE è¨Šæ¯
    if (!e || !e.postData) return;
    var msgObj = JSON.parse(e.postData.contents);
    var event = msgObj.events[0];
    if (!event) return;

    var replyToken = event.replyToken;
    var userId = event.source.userId;
    var userMsg = (event.type === 'message' && event.message.type === 'text') ? event.message.text.trim() : '';

    // ğŸ§  æ™ºæ…§ç¶å®šåˆ¤æ–·ï¼šå¦‚æœæ˜¯æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå€åˆ†æ˜¯ã€Œæ–°ç¶å®šã€ã€ã€Œé‡è¤‡è¼¸å…¥ã€é‚„æ˜¯ã€Œæ›´æ–°è™Ÿç¢¼ã€
    if (/^09\d{8}$/.test(userMsg)) {
      var resultMsg = processPhoneBinding(userId, userMsg);
      replyMessage(replyToken, resultMsg);
    } else if (userMsg === 'æŸ¥è©¢ID') {
      replyMessage(replyToken, "æ‚¨çš„ UserID æ˜¯ï¼š\n" + userId + "\n\n(è«‹å°‡æ­¤ ID å¡«å…¥ç¨‹å¼ç¢¼çš„ MANAGER_USER_ID ä»¥æ¥æ”¶ç®¡ç†å“¡é€šçŸ¥)");
    } else {
      if (userId !== MANAGER_USER_ID) {
        replyMessage(replyToken, "ğŸ‘‹ æ‚¨å¥½ï¼Œè«‹ç›´æ¥è¼¸å…¥æ‚¨çš„ã€Œæ‰‹æ©Ÿè™Ÿç¢¼ã€é€²è¡Œç¶å®š (ä¾‹å¦‚ï¼š0912345678)ã€‚");
      }
    }

  } catch (err) {
    console.error("doPost Error: " + err.toString());
  } finally {
    lock.releaseLock();
  }
}

// ==========================================
// 3. æ—¥æ›†ç›£æ§èˆ‡é€šçŸ¥ (Calendar Watcher)
// ==========================================

function setupCalendarWebhook() {
  if (WEB_APP_URL.indexOf('YOUR_') > -1) {
    SpreadsheetApp.getUi().alert("âŒ éŒ¯èª¤ï¼šè«‹å…ˆå°‡éƒ¨ç½²å¾Œçš„ Web App URL å¡«å…¥ç¨‹å¼ç¢¼ä¸Šæ–¹ï¼Œæ‰èƒ½å•Ÿå‹•ç›£æ§ã€‚");
    return;
  }

  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
  
  // åŸæœ‰æ’ç¨‹
  ScriptApp.newTrigger('renewCalendarWebhook').timeBased().everyDays(1).atHour(5).create();
  ScriptApp.newTrigger('runDailyReport').timeBased().everyDays(1).atHour(8).create(); 
  
  // ğŸ†• æ–°å¢ï¼šæ¯å¤©æ™šä¸Š 6 é»åŸ·è¡Œã€Œæ˜æ—¥é ç´„æé†’ã€
  ScriptApp.newTrigger('runPreArrivalReminder').timeBased().everyDays(1).atHour(18).create();

  try {
    var now = new Date();
    var pageToken = null;
    var nextSyncToken = null;
    
    do {
      var options = {
        timeMin: now.toISOString(),
        maxResults: 100 
      };
      if (pageToken) options.pageToken = pageToken;
      var list = Calendar.Events.list(CALENDAR_ID, options);
      if (list.nextSyncToken) {
        nextSyncToken = list.nextSyncToken;
        break; 
      }
      pageToken = list.nextPageToken;
    } while (pageToken);

    if (nextSyncToken) {
      PropertiesService.getScriptProperties().setProperty("CAL_SYNC_TOKEN", nextSyncToken);
      console.log("âœ… Initial Sync Token Set: " + nextSyncToken);
    } 

  } catch (e) {
    console.error("Initial Sync Failed: " + e);
    SpreadsheetApp.getUi().alert('âŒ åˆå§‹åŒ–å¤±æ•— (Sync Token Error)');
    return;
  }

  var channelId = "bot-calendar-watch-" + new Date().getTime();
  var resource = {
    id: channelId,
    type: "web_hook",
    address: WEB_APP_URL + "?source=calendar"
  };

  try {
    var response = Calendar.Events.watch(resource, CALENDAR_ID);
    console.log("Webhook Resource ID: " + response.resourceId);
    SpreadsheetApp.getUi().alert('âœ… ç›£æ§å·²å•Ÿå‹•ï¼\n(å·²è¨­å®šæ¯æ—¥ 08:00 ç™¼æ—¥å ±ã€18:00 ç™¼æ˜æ—¥æé†’)');
  } catch (e) {
    console.error(e);
    SpreadsheetApp.getUi().alert('âŒ å•Ÿå‹•å¤±æ•—: ' + e.message + '\n\nè«‹æª¢æŸ¥ Web App URL æ˜¯å¦æ­£ç¢ºï¼Œä¸¦ç¢ºèªå·²éƒ¨ç½²ç‚ºã€Œä»»ä½•äººã€å¯è®€å–ã€‚');
  }
}

function renewCalendarWebhook() {
  var channelId = "bot-calendar-watch-" + new Date().getTime();
  var resource = { id: channelId, type: "web_hook", address: WEB_APP_URL + "?source=calendar" };
  try { Calendar.Events.watch(resource, CALENDAR_ID); } catch(e) {}
}

function handleCalendarWebhook() {
  var props = PropertiesService.getScriptProperties();
  var syncToken = props.getProperty('CAL_SYNC_TOKEN');
  var options = { maxResults: 50 };
  
  if (syncToken) {
    options.syncToken = syncToken;
  } else {
    var safetyTime = new Date();
    safetyTime.setMinutes(safetyTime.getMinutes() - 5);
    options.timeMin = safetyTime.toISOString();
  }
  
  try {
    var eventList = Calendar.Events.list(CALENDAR_ID, options);
    if (eventList.nextSyncToken) {
      props.setProperty('CAL_SYNC_TOKEN', eventList.nextSyncToken);
    }

    if (!eventList.items || eventList.items.length === 0) return;

    var memberMap = getMemberMap(); 

    for (var i = 0; i < eventList.items.length; i++) {
      var event = eventList.items[i];
      if (event.status === 'confirmed') {
        processEventNotification(event, memberMap);
      }
    }
  } catch (e) {
    if (e.message.indexOf('Sync token') > -1) {
      props.deleteProperty('CAL_SYNC_TOKEN'); 
    }
    console.error("Calendar Sync Error: " + e.toString());
  }
}

function processEventNotification(event, memberMap) {
  var created = new Date(event.created);
  var updated = new Date(event.updated);
  var now = new Date();

  var timeDiff = (now.getTime() - updated.getTime()) / 60000; 
  if (timeDiff > 5) return; 
  
  var isNew = (Math.abs(updated - created) < 60000);
  var title = event.summary || "æœªå‘½åé ç´„";
  var desc = event.description || "";
  var startTime = new Date(event.start.dateTime || event.start.date);
  var timeStr = Utilities.formatDate(startTime, "GMT+8", "yyyy/MM/dd HH:mm");
  var phone = extractPhoneNumber(title + " " + desc);
  
  var managerMsg = (isNew ? "ğŸ†• æ–°å¢é ç´„é€šçŸ¥" : "ğŸ”„ é ç´„è®Šæ›´é€šçŸ¥") + "\n\n" +
                   "ğŸ“… æ™‚é–“ï¼š" + timeStr + "\n" +
                   "ğŸ‘¤ é¡§å®¢ï¼š" + title + "\n" +
                   "ğŸ“ é›»è©±ï¼š" + (phone || "æœªåµæ¸¬åˆ°");
  
  pushMessage(MANAGER_USER_ID, managerMsg);
  
  if (phone && memberMap[phone]) {
    var userMsg = "âœ… é ç´„ç¢ºèªé€šçŸ¥\n\n" +
                  "è¦ªæ„›çš„é¡§å®¢æ‚¨å¥½ï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ï¼š\n" +
                  "ğŸ“… æ™‚é–“ï¼š" + timeStr + "\n" +
                  "ğŸ“Œé …ç›®ï¼š" + title + "\n\n" +
                  "æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼";
    pushMessage(memberMap[phone], userMsg);
  }
}

// ==========================================
// 4. å®šæ™‚å ±å‘Šèˆ‡æé†’ (Reports & Reminders)
// ==========================================

function runDailyReport() {
  if (!MANAGER_USER_ID || MANAGER_USER_ID.indexOf('YOUR_') > -1) {
    console.log("å°šæœªè¨­å®š MANAGER_USER_IDï¼Œè·³éæ—¥å ±");
    return;
  }

  var today = new Date();
  var events = CalendarApp.getCalendarById(CALENDAR_ID).getEventsForDay(today);
  var dateStr = Utilities.formatDate(today, "GMT+8", "yyyy/MM/dd");
  var report = "ğŸ“Š åº—é•·æ—¥å ± [" + dateStr + "]\n";
  
  if (events.length === 0) {
    report += "\nğŸµ ä»Šæ—¥ç„¡é ç´„è¡Œç¨‹ã€‚";
  } else {
    report += "\nä»Šæ—¥å…±æœ‰ " + events.length + " çµ„é ç´„ï¼š\n";
    for (var i = 0; i < events.length; i++) {
      var evt = events[i];
      var time = Utilities.formatDate(evt.getStartTime(), "GMT+8", "HH:mm");
      var title = evt.getTitle();
      report += "\n" + (i+1) + ". " + time + " " + title;
    }
  }
  pushMessage(MANAGER_USER_ID, report);
}

// ğŸ†• æ–°å¢ï¼šæ˜æ—¥é ç´„æé†’
function runPreArrivalReminder() {
  var today = new Date();
  var tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1); // å–å¾—æ˜å¤©çš„æ—¥æœŸ
  
  var events = CalendarApp.getCalendarById(CALENDAR_ID).getEventsForDay(tomorrow);
  
  if (events.length === 0) return; // æ˜å¤©æ²’äº‹å°±ä¼‘æ¯
  
  var memberMap = getMemberMap();
  var count = 0;

  for (var i = 0; i < events.length; i++) {
    var evt = events[i];
    var title = evt.getTitle();
    var desc = evt.getDescription();
    
    // å¾æ¨™é¡Œæˆ–å‚™è¨»æŠ“é›»è©±
    var phone = extractPhoneNumber(title + " " + desc);
    
    if (phone && memberMap[phone]) {
      var timeStr = Utilities.formatDate(evt.getStartTime(), "GMT+8", "HH:mm");
      var userMsg = "ğŸ”” æ˜æ—¥é ç´„æé†’\n\n" +
                    "è¦ªæ„›çš„é¡§å®¢æ‚¨å¥½ï¼Œæé†’æ‚¨æ˜å¤©æœ‰é ç´„å–”ï¼\n" + 
                    "ğŸ“… æ™‚é–“ï¼š" + timeStr + "\n" +
                    "ğŸ“Œ é …ç›®ï¼š" + title + "\n\n" +
                    "å¦‚æœæœ‰ä»»ä½•è®Šå‹•ï¼Œè«‹æå‰å‘ŠçŸ¥æˆ‘å€‘ï¼Œè¬è¬ï¼";
      
      pushMessage(memberMap[phone], userMsg);
      count++;
    }
  }
  console.log("å·²ç™¼é€ " + count + " å‰‡æ˜æ—¥é ç´„æé†’");
}

// ==========================================
// å·¥å…·å‡½å¼
// ==========================================

// ğŸ”„ è™•ç†æœƒå“¡ç¶å®š (å€åˆ†æ–°èˆŠç”¨æˆ¶)
function processPhoneBinding(userId, phone) {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sheet = ss.getSheetByName(SHEET_TAB_NAME);
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][0]) === userId) {
      var oldPhone = String(data[i][1]).replace(/['\s-]/g, '');
      
      if (oldPhone === phone) {
        return "â„¹ï¸ æ‚¨å·²ç¶“ç¶å®šéé€™å€‹è™Ÿç¢¼ (" + phone + ") å›‰ï¼Œä¸éœ€è¦é‡è¤‡è¨­å®šã€‚";
      } else {
        sheet.getRange(i + 1, 2).setValue("'" + phone);
        return "ğŸ”„ æ›´æ–°æˆåŠŸï¼\n\nå·²å°‡æ‚¨çš„ç¶å®šé›»è©±ä¿®æ”¹ç‚ºï¼š" + phone;
      }
    }
  }
  
  var time = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM/dd HH:mm");
  sheet.appendRow([userId, "'" + phone, 'User', time]);
  return "âœ… ç¶å®šæˆåŠŸï¼\n\næ‚¨çš„é›»è©±ï¼š" + phone + "\n\nç•¶æ‚¨åœ¨ Google æ—¥æ›†ä¸Šæœ‰é ç´„æ™‚ï¼Œç³»çµ±å°‡æœƒè‡ªå‹•ç™¼é€æé†’çµ¦æ‚¨ã€‚";
}

function getMemberMap() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sheet = ss.getSheetByName(SHEET_TAB_NAME);
  var data = sheet.getDataRange().getValues();
  var map = {};
  for (var i = 1; i < data.length; i++) {
    var uid = data[i][0];
    var phone = String(data[i][1]).replace(/['\s-]/g, '');
    if (uid && phone) map[phone] = uid;
  }
  return map;
}

function extractPhoneNumber(text) {
  if (!text) return null;
  var match = text.replace(/[- ]/g, '').match(/(09\d{8})/);
  return match ? match[1] : null;
}

function pushMessage(userId, text) {
  try {
    UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
      'headers': {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN
      },
      'method': 'post',
      'payload': JSON.stringify({
        'to': userId,
        'messages': [{ 'type': 'text', 'text': text }]
      })
    });
  } catch (e) {
    console.error("Push Error: " + e.message);
  }
}

function replyMessage(replyToken, text) {
  try {
    UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
      'headers': {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN
      },
      'method': 'post',
      'payload': JSON.stringify({
        'replyToken': replyToken,
        'messages': [{ 'type': 'text', 'text': text }]
      })
    });
  } catch (e) {
    console.error("Reply Error: " + e.message);
  }
}
